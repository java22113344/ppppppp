/*
   GENERIC MALWARE DETECTION RULES
   Detects common malware characteristics
   Covers: Trojans, Backdoors, Droppers
*/

rule Malware_Generic_Suspicious_Imports {
    meta:
        description = "Detects generic suspicious API imports"
        author = "Security Team"
        date = "2026-01-03"
        severity = 7
    
    strings:
        $api1 = "CreateRemoteThread"
        $api2 = "WriteProcessMemory"
        $api3 = "VirtualAllocEx"
        $api4 = "SetWindowsHookEx"
        $api5 = "GetAsyncKeyState"
        $api6 = "InternetOpenA"
        $api7 = "WinExec"
        $api8 = "ShellExecute"
        $api9 = "CreateProcess"
    
    condition:
        3 of them
}

rule Malware_Generic_Suspicious_Strings {
    meta:
        description = "Detects strings associated with malware"
        severity = 6
    
    strings:
        $str1 = "cmd.exe"
        $str2 = "powershell"
        $str3 = "rundll32"
        $str4 = "regsvr32"
        $str5 = "mshta.exe"
        $str6 = "cscript.exe"
        $str7 = "wscript.exe"
        $str8 = /http:\/\/.*\/[a-z]+\.exe/
        $str9 = "System32"
    
    condition:
        2 of them
}

rule Malware_Generic_Registry_Modification {
    meta:
        description = "Detects registry modification patterns"
        severity = 5
    
    strings:
        $reg1 = "RegSetValue"
        $reg2 = "RegCreateKey"
        $reg3 = "RegOpenKey"
        $reg4 = "HKEY_LOCAL_MACHINE"
        $reg5 = "Software\\Microsoft\\Windows\\Run"
        $reg6 = "Software\\Microsoft\\Windows\\CurrentVersion\\Run"
    
    condition:
        2 of them
}

rule Malware_Generic_Anti_Analysis {
    meta:
        description = "Detects anti-analysis/anti-VM techniques"
        severity = 8
    
    strings:
        $aa1 = "IsDebuggerPresent"
        $aa2 = "GetTickCount"
        $aa3 = "OutputDebugString"
        $aa4 = "CheckRemoteDebuggerPresent"
        $aa5 = "VmDetect"
        $aa6 = "VMware"
        $aa7 = "VirtualBox"
        $aa8 = "QEMU"
        $aa9 = "Xen"
    
    condition:
        2 of them
}

rule Malware_Generic_File_Hiding {
    meta:
        description = "Detects file hiding techniques"
        severity = 6
    
    strings:
        $hide1 = "SetFileAttributes"
        $hide2 = "FILE_ATTRIBUTE_HIDDEN"
        $hide3 = "AttachProcess"
        $hide4 = "CreateFileA"
        $hide5 = "WriteFile"
        $hide6 = /\%appdata\%/
        $hide7 = /\%temp\%/
        $hide8 = "ADS"
    
    condition:
        2 of them
}

rule Malware_Generic_Persistence {
    meta:
        description = "Detects persistence mechanisms"
        severity = 7
    
    strings:
        $persist1 = "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"
        $persist2 = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"
        $persist3 = "Startup"
        $persist4 = "StartupFolder"
        $persist5 = "LoadOnBoot"
        $persist6 = "Services"
    
    condition:
        1 of them
}

rule Malware_Generic_Process_Injection {
    meta:
        description = "Detects code injection patterns"
        severity = 9
    
    strings:
        $inject1 = "CreateRemoteThread"
        $inject2 = "WriteProcessMemory"
        $inject3 = "VirtualAllocEx"
        $inject4 = "SetWindowsHookEx"
        $inject5 = "CreateProcess"
        $inject6 = "ResumeThread"
        $inject7 = "OpenProcess"
    
    condition:
        4 of them
}

rule Malware_Generic_DLL_Injection {
    meta:
        description = "Detects DLL injection techniques"
        severity = 8
    
    strings:
        $dll1 = "LoadLibrary"
        $dll2 = "GetProcAddress"
        $dll3 = "CreateRemoteThread"
        $dll4 = "WriteProcessMemory"
        $dll5 = ".dll"
        $dll6 = "DLL"
    
    condition:
        4 of them
}

rule Malware_Packed_UPX {
    meta:
        description = "Detects UPX packed executables"
        severity = 6
    
    strings:
        $upx1 = "UPX"
        $upx2 = {55 50 58 21}  // UPX! signature
    
    condition:
        1 of them
}

rule Malware_Packed_Generic {
    meta:
        description = "Detects generic packed executables"
        severity = 5
    
    strings:
        $pack1 = "!This program cannot be run"
        $pack2 = "Rich"
        $entropy_high = /.{256}/
    
    condition:
        1 of them
}
